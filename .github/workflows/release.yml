name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (for example: v0.1.0)"
        required: true
        type: string

permissions:
  contents: write
  attestations: write
  id-token: write

env:
  CARGO_TERM_COLOR: always
  BIN_NAME: vacuum

jobs:
  validate-version:
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.tag.outputs.release_tag }}
      release_version: ${{ steps.version.outputs.release_version }}
    steps:
      - uses: actions/checkout@v4
      - name: Resolve release tag
        id: tag
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi
          echo "release_tag=$TAG" >> "$GITHUB_OUTPUT"
      - name: Read crate version
        id: version
        shell: bash
        run: |
          VERSION=$(python3 -c "import tomllib; from pathlib import Path; print(tomllib.loads(Path('Cargo.toml').read_text())['package']['version'])")
          if [[ -z "$VERSION" ]]; then
            echo "Failed to read version from Cargo.toml" >&2
            exit 1
          fi
          echo "release_version=$VERSION" >> "$GITHUB_OUTPUT"
      - name: Validate tag matches Cargo.toml version
        shell: bash
        run: |
          TAG="${{ steps.tag.outputs.release_tag }}"
          VERSION="${{ steps.version.outputs.release_version }}"
          if [[ "${TAG#v}" != "$VERSION" ]]; then
            echo "Tag '$TAG' does not match Cargo.toml version '$VERSION'" >&2
            exit 1
          fi

  build:
    needs: validate-version
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_ext: tar.gz
            use_cross: false
          - runner: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact_ext: tar.gz
            use_cross: true
          - runner: macos-13
            target: x86_64-apple-darwin
            artifact_ext: tar.gz
            use_cross: false
          - runner: macos-14
            target: aarch64-apple-darwin
            artifact_ext: tar.gz
            use_cross: false
          - runner: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_ext: zip
            use_cross: false
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      - name: Install cross for aarch64 Linux build
        if: matrix.use_cross
        shell: bash
        run: cargo install cross --locked
      - name: Build binary
        shell: bash
        run: |
          if [[ "${{ matrix.use_cross }}" == "true" ]]; then
            cross build --release --target "${{ matrix.target }}"
          else
            cargo build --release --target "${{ matrix.target }}"
          fi
      - name: Package artifact
        shell: bash
        run: |
          mkdir -p dist
          TAG="${{ needs.validate-version.outputs.release_tag }}"
          TARGET="${{ matrix.target }}"
          ARTIFACT="vacuum-${TAG}-${TARGET}"

          if [[ "$TARGET" == *"windows"* ]]; then
            BIN_PATH="target/$TARGET/release/${BIN_NAME}.exe"
            7z a "dist/${ARTIFACT}.zip" "$BIN_PATH" >/dev/null
          else
            BIN_PATH="target/$TARGET/release/${BIN_NAME}"
            tar -C "target/$TARGET/release" -czf "dist/${ARTIFACT}.tar.gz" "${BIN_NAME}"
          fi
      - name: Generate SPDX SBOM
        uses: anchore/sbom-action/download-syft@v0
      - name: Write SPDX SBOM file
        shell: bash
        run: |
          syft "dir:${{ github.workspace }}" -o spdx-json > "dist/vacuum-${{ matrix.target }}.spdx.json"
      - name: Upload target artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.target }}
          path: dist/*

  publish:
    needs:
      - validate-version
      - build
    runs-on: ubuntu-latest
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release
      - name: Generate SHA256SUMS
        shell: bash
        run: |
          cd release
          find . -type f \( -name "*.tar.gz" -o -name "*.zip" -o -name "*.spdx.json" \) -print0 \
            | sort -z \
            | xargs -0 sha256sum > SHA256SUMS
      - name: Attest build provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: |
            release/**/*.tar.gz
            release/**/*.zip
            release/**/*.spdx.json
            release/SHA256SUMS
      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate-version.outputs.release_tag }}
          generate_release_notes: true
          files: |
            release/**/*.tar.gz
            release/**/*.zip
            release/**/*.spdx.json
            release/SHA256SUMS
